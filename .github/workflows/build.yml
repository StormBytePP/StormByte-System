name: Compile & Test

permissions:
  actions: write

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  
  workflow_dispatch:

env:
  BUILD_TYPE: Debug

jobs:
  build-linux:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        compiler: [gcc, clang, clang-libc++]
    
    name: ${{ matrix.compiler }}

    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Install toolchain
      id: install-toolchain
      uses: stormbytepp/githubactions/.github/actions/install-toolchain@master
      with:
        toolchain: ${{ matrix.compiler }}
        ccache-key: 'ccache-${{ matrix.compiler }}-v1'
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Build with CMake
      uses: ashutoshvarma/action-cmake-build@master
      with:
        build-dir: ${{ github.workspace }}/build
        cc: ${{ steps.install-toolchain.outputs.c_compiler }}
        cxx: ${{ steps.install-toolchain.outputs.cxx_compiler }}
        configure-options: >-
          -G Ninja
          -DENABLE_ASAN=ON
          -DENABLE_TEST=ON
          -DWITH_STORMBYTE=BUNDLED
          ${{ matrix.compiler == 'clang-libc++' && format('-DCMAKE_CXX_FLAGS=-stdlib={0}', 'libc++') || '' }}
        build-type: ${{ env.BUILD_TYPE }}
        run-test: true
        ctest-options: --output-on-failure --test-dir ${{ github.workspace }}/build/test

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch:
          - x64

    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install toolchain
        id: install-toolchain
        uses: stormbytepp/githubactions/.github/actions/install-toolchain@master
        with:
          toolchain: msvc

      - name: Build with CMake
        uses: ashutoshvarma/action-cmake-build@master
        with:
          build-dir: ${{ github.workspace }}\build
          configure-options: >-
            -G Ninja
            -DENABLE_TEST=ON
            -DWITH_STORMBYTE=BUNDLED
          build-type: ${{ env.BUILD_TYPE }}

      - name: Add DLL directory to PATH
        run: |
          echo "${{ github.workspace }}\build\lib" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "${{ github.workspace }}\build\thirdparty\buildmaster\install\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
      - name: Run unit tests
        run: ctest --output-on-failure --test-dir ${{ github.workspace }}\build\test